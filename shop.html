<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pawthways — Shop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{border:1px solid #e6e6e6;border-radius:8px;padding:12px;background:#fff}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:6px}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#2b7be4;color:#fff;text-decoration:none;cursor:pointer;border:none}
  </style>
</head>
<body>
  <h1>Pawthways — Shop</h1>
  <p>40% of sales goes to rescues.</p>
  <div id="products" class="grid">Loading...</div>

  <script>
    async function loadProducts() {
      const el = document.getElementById('products');

      try {
        const r = await fetch('/api/products');
        const data = await r.json();

        if (!Array.isArray(data) || data.length === 0) {
          el.innerHTML = '<p>No products available.</p>';
          return;
        }

        // Render cards
        el.innerHTML = data.map(p => 
          <div class="card">
            ${p.image_url ? <img src="${p.image_url}" alt="${p.title}"> : ''}
            <h3>${p.title}</h3>
            <p>${p.description || ''}</p>
            <p><strong>${p.price} ${p.currency || 'EUR'}</strong></p>

            <button class="btn buy-btn" data-slug="${p.slug}">
              Buy now
            </button>
          </div>
        ).join('');

        // Click handler para botón Buy now
        document.querySelectorAll('.buy-btn').forEach(btn => {
          btn.onclick = async () => {
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
              const res = await fetch(/api/buy?product=${btn.dataset.slug}, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });

              const json = await res.json();

              if (json.whop_url) {
                window.open(json.whop_url, '_blank');
                btn.textContent = 'Reserved ✓';
              } else if (json.success) {
                btn.textContent = 'Reserved ✓';
              } else {
                btn.textContent = 'Error';
                btn.disabled = false;
              }
            } catch (err) {
              console.error(err);
              btn.textContent = 'Error';
              btn.disabled = false;
            }
          };
        });

      } catch (err) {
        console.error(err);
        el.innerHTML = '<p>Error loading products</p>';
      }
    }

    loadProducts();
  </script>

</body>
</html>