<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>How it works — Revenue Model (Pawthways)</title>
  <meta name="description" content="Transparency: how Pawthways generates revenue and how 40% is allocated to animal rescues. Interactive dashboard and visual flow." />
  <!-- Chart.js CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#ffb86b; --white:#eef2f7;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--white);line-height:1.45;-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:32px auto;padding:24px}
    header{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
    h1{margin:.2em 0 0;font-size:26px}
    p.lead{color:var(--muted);margin-top:6px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(2,6,23,0.6);margin:16px 0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
    .full{grid-column:1/-1}
    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .num{font-weight:700;font-size:20px}
    .cta{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#0b1220;text-decoration:none;font-weight:600}
    footer{color:var(--muted);font-size:13px;margin-top:18px}
    pre.note{background:#07111a;padding:12px;border-radius:8px;color:var(--muted);overflow:auto}
    /* Responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr}.wrap{padding:18px}}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;color:var(--muted)}
    th{color:var(--white);font-weight:600}
    /* Tooltip styling for SVG */
    .svg-tooltip{
      position:fixed;pointer-events:none;padding:8px 10px;border-radius:8px;background:#07111a;color:var(--muted);font-size:13px;border:1px solid rgba(255,255,255,0.03);z-index:60;display:none;
    }
    /* small helper */
    .muted{color:var(--muted)}
    .kpiRow{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .kpiBox{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;min-width:140px}
    .kpiBox .label{color:var(--muted);font-size:13px}
    .kpiBox .value{font-weight:700;font-size:18px;margin-top:6px}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <header>
      <div>
        <h1>How it works — Revenue Model (Pawthways)</h1>
        <p class="lead">Full transparency: interactive flow diagram and real-time metrics (if the endpoint is enabled).</p>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div style="background:rgba(255,184,107,0.12);color:var(--accent);padding:8px 10px;border-radius:999px;font-weight:700">40% → Donation</div>
        <div class="muted" style="font-size:13px;margin-top:8px">Fixed, audited distribution</div>
      </div>
    </header>

    <!-- Intro KPI row from admin-stats -->
    <section class="card full" aria-labelledby="kpi-summary">
      <h2 id="kpi-summary">Quick numbers (live)</h2>
      <div class="kpiRow" id="kpiRow">
        <div class="kpiBox">
          <div class="label">Total revenue</div>
          <div class="value" id="k_total_revenue">—</div>
        </div>
        <div class="kpiBox">
          <div class="label">Total reserved / donated</div>
          <div class="value" id="k_total_reserved">—</div>
        </div>
        <div class="kpiBox">
          <div class="label">Donation %</div>
          <div class="value" id="k_donation_pct">—</div>
        </div>
        <div class="kpiBox">
          <div class="label">Pending allocations</div>
          <div class="value" id="k_pending">—</div>
        </div>
      </div>
      <p class="muted" style="margin-top:10px">These numbers come from the server (endpoint <code>/api/admin-stats</code>). If unavailable the visualizations fall back to default 40/60.</p>
    </section>

    <!-- TOP: flow + chart -->
    <section class="grid">
      <!-- Flow diagram (interactive) -->
      <article class="card" aria-labelledby="flow-title">
        <h3 id="flow-title">Revenue generation & distribution flow</h3>
        <p class="muted" style="margin-top:6px">Hover or tap the nodes to see details.</p>

        <!-- Inline interactive SVG -->
        <div style="width:100%;height:300px;margin-top:12px">
          <svg id="flow-svg" viewBox="0 0 1000 300" role="img" aria-label="Interactive revenue flow diagram" style="width:100%;height:100%">
            <!-- Nodes -->
            <g class="node" data-title="Digital product sales" data-desc="Sales of products on Whop (artbooks, AI packs, music)">
              <circle cx="170" cy="200" r="40" fill="#aee1ef"></circle>
              <text x="170" y="210" font-size="13" font-weight="700" text-anchor="middle" fill="#0b1220">Digital Product Sales</text>
            </g>

            <g class="node" data-title="Whop (platform)" data-desc="Payment processing platform.">
              <circle cx="420" cy="120" r="46" fill="#aee1ef"></circle>
              <text x="420" y="128" font-size="13" font-weight="700" text-anchor="middle" fill="#0b1220">Whop</text>
            </g>

            <g class="node" data-title="Generated revenue" data-desc="Revenue registered in the DB (sales).">
              <circle cx="620" cy="120" r="64" fill="#aee1ef"></circle>
              <text x="620" y="118" font-size="13" font-weight="700" text-anchor="middle" fill="#0b1220">Generated Revenue</text>
            </g>

            <g class="node" data-title="Donations (40%)" data-desc="40% redirected to verified NGOs (rescue, vet care, rehab)">
              <circle cx="920" cy="200" r="54" fill="#ffb3b3"></circle>
              <text x="920" y="208" font-size="13" font-weight="700" text-anchor="middle" fill="#0b1220">Charitable Causes (40%)</text>
            </g>

            <g class="node" data-title="Production & growth (60%)" data-desc="60% for team, marketing and content production">
              <circle cx="160" cy="30" r="48" fill="#9ecbff"></circle>
              <text x="160" y="36" font-size="13" font-weight="700" text-anchor="middle" fill="#0b1220">Production & Growth (60%)</text>
            </g>

            <!-- Arrows -->
            <defs>
              <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 z" fill="#7b8794"></path>
              </marker>
            </defs>

            <path d="M210 195 C300 170 360 140 380 135" stroke="#7b8794" stroke-width="3" fill="none" marker-end="url(#arrow)"></path>
            <path d="M470 120 C540 120 580 120 610 120" stroke="#7b8794" stroke-width="3" fill="none" marker-end="url(#arrow)"></path>
            <path d="M680 150 C760 170 820 185 870 195" stroke="#7b8794" stroke-width="3" fill="none" marker-end="url(#arrow)"></path>
            <path d="M680 100 C560 70 300 48 220 48" stroke="#7b8794" stroke-width="3" fill="none" marker-end="url(#arrow)"></path>
          </svg>
        </div>
      </article>

      <!-- Chart: interactive pie -->
      <aside class="card" aria-labelledby="chart-title">
        <h4 id="chart-title">Interactive distribution</h4>
        <p class="muted" style="margin-top:6px">Real-time data when the endpoint is available. Click legends to toggle slices.</p>
        <div style="margin-top:10px">
          <canvas id="revenuePie" width="320" height="320" aria-label="Revenue distribution pie chart" role="img"></canvas>
        </div>
        <div style="margin-top:12px" id="chart-note" class="muted">Last updated: <span id="last-updated">--</span></div>
        <div style="margin-top:14px">
          <a href="/transparency.html" class="cta">View full dashboard</a>
        </div>
      </aside>
    </section>

    <!-- Explanation & Implementation -->
    <section class="card full" aria-labelledby="impl-title">
      <h3 id="impl-title">Technical implementation & data</h3>
      <ol>
        <li>We use the existing public endpoint: <code>/api/admin-stats</code>. It returns aggregated numbers used by the chart (see below).</li>
        <li>The chart attempts to fetch real data; if unavailable it falls back to a 40% / 60% default.</li>
        <li>Do not expose PII: the public view must return only aggregated values and recent transfers without personal data.</li>
      </ol>
      <pre class="note">NOTE: allocate and audit_donations_log already run in the backend; this page only reads aggregates to show public transparency.</pre>
    </section>

    <footer>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>© Pawthways — Transparency & responsibility.</div>
        <div class="muted">Base documentation: revenue model and operational checklist.</div>
      </div>
    </footer>
  </main>

  <!-- Tooltip element -->
  <div id="svgTooltip" class="svg-tooltip" role="tooltip" aria-hidden="true"></div>

  <script>
  // ---------- Interactivity for SVG nodes (tooltips) ----------
  (function(){
    const svg = document.getElementById('flow-svg');
    const tooltip = document.getElementById('svgTooltip');

    function showTooltip(evt, title, desc) {
      const clientX = evt.clientX || (evt.touches && evt.touches[0] && evt.touches[0].clientX) || 0;
      const clientY = evt.clientY || (evt.touches && evt.touches[0] && evt.touches[0].clientY) || 0;
      tooltip.style.left = (clientX + 12) + 'px';
      tooltip.style.top = (clientY + 12) + 'px';
      tooltip.innerHTML = '<strong style="color:white">' + title + '</strong><div style="margin-top:6px;color:var(--muted);font-size:13px">' + desc + '</div>';
      tooltip.style.display = 'block';
      tooltip.setAttribute('aria-hidden','false');
    }
    function hideTooltip(){
      tooltip.style.display = 'none';
      tooltip.setAttribute('aria-hidden','true');
    }

    // attach events to groups with class "node"
    svg.querySelectorAll('.node').forEach(g => {
      const title = g.getAttribute('data-title') || '';
      const desc = g.getAttribute('data-desc') || '';
      g.style.cursor = 'pointer';
      g.addEventListener('mousemove', (e)=> showTooltip(e, title, desc));
      g.addEventListener('mouseleave', hideTooltip);
      g.addEventListener('touchstart', (e)=> { e.preventDefault(); showTooltip(e.touches[0], title, desc); }, {passive:false});
      g.addEventListener('touchend', hideTooltip);
    });
  })();

  // ---------- Chart.js pie chart with fetch fallback (uses /api/admin-stats) ----------
  (function(){
    const ctx = document.getElementById('revenuePie').getContext('2d');
    // default data (40% / 60%)
    let data = {
      labels: ['Donations (40%)', 'Production & Growth (60%)'],
      datasets: [{
        data: [40, 60],
        backgroundColor: ['#ff8b8b', '#7fb3ff'],
        hoverOffset: 8
      }]
    };

    // Chart config
    const config = {
      type: 'pie',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#e6eef7' } },
          tooltip: { bodyColor: '#e6eef7', titleColor: '#fff' }
        }
      }
    };

    const chart = new Chart(ctx, config);

    // update UI with last updated
    function setLastUpdated(ts){
      document.getElementById('last-updated').textContent = ts ? new Date(ts).toLocaleString() : '--';
    }

    // Fetch admin-stats to populate KPIs & chart
    const adminEndpoint = '/api/admin-stats';

    async function fetchAdminStats(){
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(()=> controller.abort(), 3500);
        const res = await fetch(adminEndpoint, {signal: controller.signal});
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error('no data from admin-stats');
        const json = await res.json();

        // expected shape: { pending: 0, total_sales: 2017.00, total_reserved: 806.80, timestamp? }
        const totalSales = Number(json.total_sales || json.totalRevenue || 0);
        const totalReserved = Number(json.total_reserved || json.total_donated || (totalSales * 0.4));
        const pending = Number(json.pending || 0);
        const ts = json.timestamp || new Date().toISOString();

        // Update KPI elements
        document.getElementById('k_total_revenue').textContent = totalSales > 0 ? '€ ' + totalSales.toFixed(2) : '—';
        document.getElementById('k_total_reserved').textContent = totalReserved > 0 ? '€ ' + totalReserved.toFixed(2) : '—';
        const donationPct = totalSales > 0 ? Math.round((totalReserved / totalSales) * 100) : 40;
        document.getElementById('k_donation_pct').textContent = donationPct + '%';
        document.getElementById('k_pending').textContent = pending > 0 ? '€ ' + pending.toFixed(2) : '—';
        setLastUpdated(ts);

        // Update chart
        const rest = 100 - donationPct;
        chart.data.datasets[0].data = [donationPct, rest];
        chart.data.labels = [`Donations (${donationPct}%)`, `Production & Growth (${rest}%)`];
        chart.update();
      } catch (err) {
        console.warn('admin-stats endpoint unreachable, using defaults.', err);
        // fallback values already present in chart
        setLastUpdated(null);
        // leave KPI placeholders as '—'
      }
    }

    // initial fetch
    fetchAdminStats();

    // optional: refresh every 5 minutes (uncomment if desired)
    // setInterval(fetchAdminStats, 1000 * 60 * 5);
  })();
  </script>
</body>
</html>
