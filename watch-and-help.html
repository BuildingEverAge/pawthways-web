<!DOCTYPE HTML>
<html>
  <head>
    <title>Pawthways — Watch & Help</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript>
      <link rel="stylesheet" href="assets/css/noscript.css" />
    </noscript>
  </head>
  <body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper" class="divided">

      <!-- HERO -->
      <section
        class="banner style1 orient-left content-align-left image-position-right onload-image-fade-in onload-content-fade-right"
      >
        <div class="content">
          <h1>Watch & Help</h1>
          <p class="major">
            Real cases. Real animals. Transparent goals.
            Every card below is powered directly from our rescue database —
            no fake stories, no invisible money.
          </p>
          <ul class="actions stacked">
            <li>
              <a href="/index.html" class="button smooth-scroll-middle">
                Read the origin story
              </a>
            </li>
          </ul>
        </div>
        <div class="image">
          <img
            src="images/paw-hero.jpg"
            alt="Pawthways rescue"
          />
        </div>
      </section>

      <!-- WATCH THE STORY & HELP -->
      <section class="wrapper style1 align-center">
        <div class="inner">
          <h2>Watch the Story & Help</h2>
          <p>
            Watching and sharing this story amplifies our reach and supports
            our pledge to fund real rescues featured on Pawthways.
          </p>
          <div
            style="
              position:relative;
              padding-bottom:56.25%;
              height:0;
              overflow:hidden;
              border-radius:16px;
              max-width:960px;
              margin:0 auto;
            "
          >
            <iframe
              src="https://www.youtube.com/embed/sRBxWGkS_bg?rel=0&modestbranding=1"
              title="The Bottle That Carried Us — Pawthways"
              frameborder="0"
              allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              style="
                position:absolute;
                top:0;
                left:0;
                width:100%;
                height:100%;
                border:0;
              "
            ></iframe>
          </div>
        </div>
      </section>

      <!-- ACTIVE RESCUES LIST (Supabase-powered) -->
      <section id="active-rescues" class="wrapper style1 align-center">
        <div class="inner">
          <h2>Active Rescues You Can Help Now</h2>
          <p id="rescues-status">
            Loading verified cases...
          </p>

          <div id="rescues-list"></div>
            <!-- Cards will be injected here by JS -->
          </div>
        </div>
      </section>

      <!-- WHY THIS MATTERS / CTA -->
      <section class="wrapper style3 align-center">
        <div class="inner">
          <h2>Why this matters</h2>
          <p>
            Pawthways connects emotional stories with verifiable impact.
            When a rescue is funded or completed, you'll see it reflected here
            and in our Transparency page.
          </p>
          <ul class="actions stacked">
            <li>
              <a href="#active-rescues" class="button primary">
                Support the next rescue
              </a>
            </li>
            <li>
              <a href="/index.html" class="button">
                Relive the Pawthways story
              </a>
            </li>
            <li>
              <a href="/transparency.html" class="button">
                See Transparency
              </a>
            </li>
          </ul>
        </div>
      </section>

      <!-- FOOTER -->
      <footer class="wrapper style1 align-center">
        <div class="inner">
          <p>Pawthways — Turning one leap into thousands of second chances.</p>
        </div>
      </footer>
    </div>
    <!-- Template JS -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Pawthways: Load active rescues from Supabase -->
    <script>
  function escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function calculateProgress(rescue) {
    const target = Number(rescue.target_amount || 0);
    const donated = Number(rescue.total_donated || 0);
    let pct = target > 0 ? Math.round((donated / target) * 100) : 0;
    pct = Math.max(0, Math.min(100, pct));
    return {
      progress_pct: pct,
      total_donated: donated,
      currency: rescue.currency || ''
    };
  }

  async function loadActiveRescues() {
    const statusEl = document.getElementById('rescues-status');
    const listEl = document.getElementById('rescues-list');
    if (!statusEl || !listEl) return;

    statusEl.textContent = 'Loading verified cases...';

    let data;

    try {
      const resp = await fetch('/api/rescues', { cache: 'no-cache' });
      if (!resp.ok) throw new Error('Network response error: ' + resp.status);
      data = await resp.json();
    } catch (err) {
      console.error('Error loading rescues:', err);
      statusEl.innerHTML = 'We could not load rescues right now. <button id="retry-rescues" class="button">Reintentar</button>';
      document.getElementById('retry-rescues')?.addEventListener('click', loadActiveRescues);
      return;
    }

    if (!data || data.length === 0) {
      statusEl.textContent = 'No active rescues at this moment — check back soon.';
      listEl.innerHTML = '';
      return;
    }

    statusEl.textContent = '';

    listEl.innerHTML = data
      .map((rescue) => {
        const imgHtml = rescue.image_url
          ? `<div class="image"><img loading="lazy" src="${escapeHtml(rescue.image_url)}" alt="${escapeHtml(rescue.title || 'Rescue case')}" /></div>`
          : '';

        const goal = rescue.target_amount
          ? `Goal: ${escapeHtml(String(rescue.target_amount))} ${escapeHtml(rescue.currency)}`
          : '';

        const snippet = rescue.story
          ? (rescue.story.length > 220
              ? escapeHtml(rescue.story.substring(0, 220)) + '…'
              : escapeHtml(rescue.story))
          : '';

        const progress = calculateProgress(rescue);

        const progressHtml = `
          <div class="progress-container">
            <div class="progress-info">
              <span>Donated: ${progress.total_donated.toFixed(2)} ${escapeHtml(progress.currency)}</span>
              <span>${progress.progress_pct}% funded</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${progress.progress_pct}%;"></div>
            </div>
          </div>
        `;

        return `
          <section class="spotlight style1 orient-left content-align-left image-position-center">
            ${imgHtml}
            <div class="content">
              <h3>${escapeHtml(rescue.title)}</h3>
              <p>${rescue.animal_name ? `<strong>${escapeHtml(rescue.animal_name)}</strong> · ` : ''}${escapeHtml(rescue.location)}</p>
              ${goal ? `<p>${goal}</p>` : ''}
              ${progressHtml}
              ${snippet ? `<p>${snippet}</p>` : ''}
              <ul class="actions stacked">
                <li><a href="donate.html#donation-methods" class="button primary">Help this rescue</a></li>
              </ul>
            </div>
          </section>
        `;
      })
      .join('');
  }

  document.addEventListener('DOMContentLoaded', loadActiveRescues);
</script>
  </body>
</html>