<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin — Finance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    button{padding:10px 14px;border-radius:8px;background:#2b7be4;color:#fff;border:none;cursor:pointer}
    .log{margin-top:12px; white-space: pre-line;}
    .form-row{margin-top:12px;display:flex;gap:8px;align-items:center}
    input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ddd}
    label{font-size:0.9rem}
    .small{font-size:0.9rem;color:#555}
  </style>
</head>
<body>
  <h1>Admin — Finance</h1>
  <p class="small">Run allocation (calculate and insert 40% donations)</p>

  <button id="run">Run allocation</button>

  <div class="form-row" style="margin-top:14px;">
    <label for="donationId">Donation ID:</label>
    <input id="donationId" type="text" placeholder="uuid (e.g. bf70...)" />
    <label for="txId">TX id:</label>
    <input id="txId" type="text" placeholder="TX123" />
    <button id="markSent">Mark sent</button>
  </div>

  <div id="result" class="log"></div>

  <script>
/**
 * admin auth + helpers
 * - pide token (prompt)
 * - guarda token en sessionStorage como 'admin_token'
 * - guarda flag 'admin_ok' para evitar pedirlo cada vez
 * - añade helper fetchAdmin(url, opts) que inyecta header x-admin-token
 */

async function requireAuth() {
  if (sessionStorage.getItem('admin_ok') === '1' && sessionStorage.getItem('admin_token')) return true;

  const token = prompt('Admin token:');
  if (!token) return false;

  try {
    const r = await fetch('/api/admin-auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    const j = await r.json();
    if (r.ok && j.ok) {
      sessionStorage.setItem('admin_token', token);
      sessionStorage.setItem('admin_ok', '1');
      return true;
    } else {
      alert('Token inválido');
      return false;
    }
  } catch (e) {
    alert('Error al verificar token');
    return false;
  }
}

// helper para llamadas protegidas: inyecta header x-admin-token automáticamente
async function fetchAdmin(url, opts = {}) {
  const token = sessionStorage.getItem('admin_token');
  if (!token) throw new Error('no admin token');

  // merge headers
  const userHeaders = opts.headers || {};
  const headers = Object.assign({}, userHeaders, { 'x-admin-token': token });

  // if no explicit Content-Type and body present, default to application/json
  if (!headers['Content-Type'] && opts.body) headers['Content-Type'] = 'application/json';

  const res = await fetch(url, Object.assign({}, opts, { headers }));
  return res;
}

/* ---------- Stats ---------- */
async function fetchStats() {
  const resEl = document.getElementById('result');
  try {
    // Try admin-protected stats first (works if authenticated)
    if (sessionStorage.getItem('admin_token')) {
      const r = await fetchAdmin('/api/admin-stats', { method: 'GET' });
      if (!r.ok) {
        // fallback to public stats if available
        const pub = await fetch('/api/admin-stats'); // may 401
        if (!pub.ok) throw new Error('no stats');
        const pj = await pub.json();
        resEl.innerText = `Pendientes: ${pj.pending} • Total ventas: ${pj.total_sales} • Total reservado: ${pj.total_reserved}\n`;
        return;
      }
      const j = await r.json();
      resEl.innerText = `Pendientes: ${j.pending} • Total ventas: ${j.total_sales} • Total reservado: ${j.total_reserved}\n`;
      return;
    }
    // if no token, try public endpoint (if you have one), else show nothing
    const pub2 = await fetch('/api/admin-stats');
    if (pub2.ok) {
      const p = await pub2.json();
      resEl.innerText = `Pendientes: ${p.pending} • Total ventas: ${p.total_sales} • Total reservado: ${p.total_reserved}\n`;
    }
  } catch (e) {
    // silently ignore in UI but log
    console.warn('fetchStats error', e);
  }
}

/* ---------- Run allocation button ---------- */
document.getElementById('run').onclick = async () => {
  if (!(await requireAuth())) return;

  const btn = document.getElementById('run');
  const resEl = document.getElementById('result');
  btn.disabled = true;
  btn.textContent = 'Running...';
  // keep existing stats text while running
  const prev = resEl.innerText || '';

  try {
    const r = await fetchAdmin('/api/allocate', { method: 'POST' });
    const j = await r.json();
    if (r.ok) {
      resEl.innerText = `Processed: ${j.processed || 0} • Total allocated: ${j.total_allocated || 0}\n` + prev;
    } else {
      resEl.innerText = `Error: ${j.error || 'unknown'}\n` + prev;
    }
  } catch (err) {
    resEl.innerText = 'Request error: ' + err.message + '\n' + prev;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Run allocation';
    // refresh stats
    fetchStats();
  }
};

/* ---------- Mark donation as sent form ---------- */
document.getElementById('markSent').onclick = async () => {
  if (!(await requireAuth())) return;

  const donationId = document.getElementById('donationId').value.trim();
  const txId = document.getElementById('txId').value.trim();
  if (!donationId || !txId) {
    alert('donationId y txId requeridos');
    return;
  }

  const resEl = document.getElementById('result');
  try {
    const r = await fetchAdmin('/api/mark-donation-sent', {
      method: 'POST',
      body: JSON.stringify({ donation_id: donationId, tx_id: txId })
    });
    const j = await r.json();
    if (r.ok) {
      resEl.innerText = `Marked sent: ${j.data?.id || donationId}\n` + (resEl.innerText || '');
      // clear inputs
      document.getElementById('donationId').value = '';
      document.getElementById('txId').value = '';
    } else {
      resEl.innerText = `Error marking: ${j.error || 'unknown'}\n` + (resEl.innerText || '');
    }
  } catch (e) {
    resEl.innerText = 'Request error: ' + e.message + '\n' + (resEl.innerText || '');
  } finally {
    fetchStats();
  }
};

/* ---------- Init ---------- */
fetchStats();
  </script>
</body>
</html>
